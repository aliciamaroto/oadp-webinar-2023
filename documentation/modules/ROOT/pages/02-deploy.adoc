= Install and configure OADP Operator
include::_attributes.adoc[]

This section includes the necessary steps to start working on the webinar. This guide will begin with the installation and configuration of the OADP Operator. 

In order to perform backups and restores in OpenShift using this approach, you also need to have configured an object storage as backup location. The object storage can be on of the following:

- Amazon Web Services
- Microsoft Azure
- Google Cloud Platform
- Multi Cloud Object Gateway
- AWS S3 compatible object storage, such as Noobaa or Minio.

To perform the PVs backups with snapshots, we will need:

- Amazon Web Services
- Microsoft Azure
- Google Cloud Platform
- CSI snapshot-enabled cloud provider, such as OpenShift Container Storage (OCS) or OpenShift Data Foundation (ODF)

[#install]
== Install operator

The OADP Operator can be installed through the Operator Hub as shown below:

image::deploy/operator-install.png[]


[#configure]
== Configure Operator

Once the Operator is installed, we need to configure the object storage and create a secret in OpenShift in order to be able to access the storage locations. Finally, we need to create an instance of the Data Protection Application Object. 

=== Object Storage


=== Secret

We need to create a default secret with the credentials that allows the DataProtectionApplication to access the storage locations.

Edit the file `credentials-velero` with the credentials of your storage location.

Create the Secret with the default name:

----
oc create secret generic cloud-credentials -n openshift-adp --from-file cloud=credentials-velero
----

=== DataProtectionApplication

Edit the file `dpa.yaml` by adding the following parameters:

- `velero.config`: Complete these fields with the storage location configuration
- `credential.name`: Secret name created in the previous section.
- `velero.objectStorage`: This is the bucket that will be used to store the backups. 

[source,yaml,subs="+macros,+attributes"]

----
kind: DataProtectionApplication
apiVersion: oadp.openshift.io/v1alpha1
metadata:
 name: velero-sample
 namespace: openshift-adp
spec:
 backupLocations:
   - velero:
       config:
         profile: "default"
          region: nooobaa
          s3Url: <url>
          insecureSkipTLSVerify: "true"
          s3ForcePathStyle: "true"
        provider: aws
        default: true
        credential:
          key: cloud
          name: cloud-credentials
        objectStorage:
          bucket: <bucket_name>
          prefix: velero
  configuration:
   restic:
     enable: true
   velero:
     defaultPlugins:
       - openshift
       - aws
       - csi
----

And then, create the object:

----
oc apply -f dpa.yaml -n openshift-adp
----

Finally, to check that everything has been installed correctly:

----
oc get all -n openshift-adp
----

The output should be similar to this:

---
NAME                                                   READY   STATUS    RESTARTS   AGE
pod/node-agent-bh22m                                   1/1     Running   0          31s
pod/node-agent-p2sjt                                   1/1     Running   0          31s
pod/node-agent-wtmm5                                   1/1     Running   0          31s
pod/openshift-adp-controller-manager-f7b985677-n89ts   1/1     Running   0          6d5h
pod/velero-7bb9f5f5bc-b5dkr                            1/1     Running   0          30s

NAME                                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/openshift-adp-controller-manager-metrics-service   ClusterIP   172.30.34.236    <none>        8443/TCP   6d5h
service/openshift-adp-velero-metrics-svc                   ClusterIP   172.30.248.193   <none>        8085/TCP   32s

NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/node-agent   3         3         3       3            3           <none>          32s

NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/openshift-adp-controller-manager   1/1     1            1           6d5h
deployment.apps/velero                             1/1     1            1           32s

NAME                                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/openshift-adp-controller-manager-f7b985677   1         1         1       6d5h
replicaset.apps/velero-7bb9f5f5bc                            1         1         1       32s

---

Now, we have everything configured so we can start to create our backups. 