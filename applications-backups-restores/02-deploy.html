<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Install and configure OADP Operator :: Applications backups &amp; restores in OpenShift</title>
    <link rel="canonical" href="https://aliciamaroto.github.io/oadp-webinar-2023/applications-backups-restores/02-deploy.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-backups.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://aliciamaroto.github.io/oadp-webinar-2023">Applications backups &amp; restores in OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="applications-backups-restores" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Lab Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#clustersetup">Cluster Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deploy.html">2. Install and configure OADP Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install">Install Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#configure">Configure Operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-backups.html">3. Create Application Backups</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-backups.html#app1">Application 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-backups.html#app2">Application 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-backups.html#app3">Application 3</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-backups.html#app4">Application 4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-restores.html">4. Restore Applications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-restores.html#simple">Restore simple application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-restores.html#snapshot">Restore application with persistent storage using Snaphsots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-restores.html#restic">Restore application with persistent storage using Restic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-restores.html#datamover">Restore application with persistent storage using Data Mover</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Applications backups & restores in OpenShift</a></li>
    <li><a href="02-deploy.html">2. Install and configure OADP Operator</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/aliciamaroto/oadp-webinar-2023/edit/master/documentation/modules/ROOT/pages/02-deploy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Install and configure OADP Operator</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section includes the necessary steps to start working on the webinar. This guide will begin with the installation and configuration of the OADP Operator.</p>
</div>
<div class="paragraph">
<p>In order to perform backups and restores in OpenShift using this approach, you also need to have configured an object storage as backup location. The object storage can be on of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Amazon Web Services</p>
</li>
<li>
<p>Microsoft Azure</p>
</li>
<li>
<p>Google Cloud Platform</p>
</li>
<li>
<p>Multi Cloud Object Gateway</p>
</li>
<li>
<p>AWS S3 compatible object storage, such as Noobaa or Minio.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To perform the PVs backups with snapshots, we will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Amazon Web Services</p>
</li>
<li>
<p>Microsoft Azure</p>
</li>
<li>
<p>Google Cloud Platform</p>
</li>
<li>
<p>CSI snapshot-enabled cloud provider, such as OpenShift Container Storage (OCS) or OpenShift Data Foundation (ODF)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install"><a class="anchor" href="#install"></a>Install operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OADP Operator can be installed through the Operator Hub as shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/oadp-install.png" alt="oadp install">
</div>
</div>
<div class="paragraph">
<p>We will also need the VolSync Operator in order to perform the Data Mover feature. This operator can also be installed via the Operator Hub:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/volsync-install.png" alt="volsync install">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure"><a class="anchor" href="#configure"></a>Configure Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the Operators are installed, and we need to have the object storage configured and a secret in OpenShift that contains the credentials needed to access the storage locations. Finally, we need to create an instance of the Data Protection Application Object.</p>
</div>
<div class="sect2">
<h3 id="_secret"><a class="anchor" href="#_secret"></a>Secret</h3>
<div class="paragraph">
<p>We have to create a default secret with the storage location credentials that will allow the <code>DataProtectionApplication</code> to access the storage location.</p>
</div>
<div class="paragraph">
<p>Create a file <code>credentials-velero</code> with the credentials of your storage location. In Azure Blob, it will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AZURE_SUBSCRIPTION_ID=&lt;subscription_id&gt;
AZURE_TENANT_ID=&lt;tenant_id&gt;
AZURE_CLIENT_ID=&lt;client_id&gt;
AZURE_CLIENT_SECRET=&lt;client_password&gt;
AZURE_RESOURCE_GROUP=&lt;resource_group&gt;
AZURE_STORAGE_ACCOUNT_ACCESS_KEY=&lt;storage_account_access_key&gt;
AZURE_CLOUD_NAME=&lt;azure_cloud_name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And then, create the Secret with the default name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc create secret generic cloud-credentials-azure -n openshift-adp --from-file cloud=credentials-velero</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dataprotectionapplication"><a class="anchor" href="#_dataprotectionapplication"></a>DataProtectionApplication</h3>
<div class="paragraph">
<p>Create a new <code>DataProtectionApplication</code> resource. It can be done via web console, in the OADP Operator:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/create-dpa.png" alt="create dpa">
</div>
</div>
<div class="paragraph">
<p>The resource should look as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>velero.config</code>: Complete these fields with the storage location configuration.</p>
</li>
<li>
<p><code>credential.name</code>: Secret name created in the previous section.</p>
</li>
<li>
<p><code>velero.objectStorage</code>: This is the bucket that will be used to store the backups.</p>
</li>
<li>
<p><code>features.datamover</code>: This section configures the Data Mover feature and will be applied later on the workshop.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: DataProtectionApplication
apiVersion: oadp.openshift.io/v1alpha1
metadata:
 name: velero-sample
 namespace: openshift-adp
spec:
  backupLocations:
    - velero:
        config:
          resourceGroup: &lt;RESOURCE_GROUP&gt;
          storageAccount: &lt;STORAGE_ACCOUNT&gt;
          storageAccountKeyEnvVar: AZURE_STORAGE_ACCOUNT_ACCESS_KEY
          subscriptionId: &lt;SUBSCRIPTION_ID&gt;
        credential:
          key: cloud
          name: cloud-credentials-azure
        default: true
        objectStorage:
          bucket: &lt;BUCKET_NAME&gt;
          prefix: velero
        provider: azure
  configuration:
    restic:
      enable: true
    velero:
      defaultPlugins:
        - openshift
        - azure
        - csi
  features:
    dataMover:
      credentialName: datamover-restic-secret
      enable: false
      maxConcurrentBackupVolumes: '3'
      maxConcurrentRestoreVolumes: '3'
      pruneInterval: '1'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_mover_prerequisites"><a class="anchor" href="#_data_mover_prerequisites"></a>Data Mover Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Verify that both resources <code>StorageClass</code> and <code>VolumeSnapshotClass</code> support CSI.</p>
</li>
<li>
<p>Check that there is just one default <code>VolumeSnapshotClass</code>.</p>
</li>
<li>
<p>The default <code>VolumeSnapshotClass</code> must have the <code>deletionPolicy</code> set to <code>Retain</code> and the label <code>velero.io/csi-volumesnapshot-class</code> set to <code>true</code>. This resource should look as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: snapshot.storage.k8s.io/v1
deletionPolicy: Retain
driver: openshift-storage.cephfs.csi.ceph.com
kind: VolumeSnapshotClass
metadata:
  annotations:
    snapshot.storage.kubernetes.io/is-default-class: "true"
  labels:
    velero.io/csi-volumesnapshot-class: "true"
  name: ocs-storagecluster-cephfsplugin-snapclass
parameters:
  clusterID: openshift-storage
  csi.storage.k8s.io/snapshotter-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/snapshotter-secret-namespace: openshift-storage</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The namespace where the OADP Operator is installed has to have the annotation:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc annotate --overwrite namespace/openshift-adp volsync.backube/privileged-movers='true'</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure a Restic secret.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: restic-secret
  namespace: openshift-adp
type: Opaque
stringData:
# The repository encryption key
  RESTIC_PASSWORD: restic-password</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>oc apply -f restic-secret.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, to check that everything has been deployed correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc get all -n openshift-adp</pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                                                   READY   STATUS    RESTARTS   AGE
pod/node-agent-bh22m                                   1/1     Running   0          31s
pod/node-agent-p2sjt                                   1/1     Running   0          31s
pod/node-agent-wtmm5                                   1/1     Running   0          31s
pod/openshift-adp-controller-manager-f7b985677-n89ts   1/1     Running   0          6d5h
pod/velero-7bb9f5f5bc-b5dkr                            1/1     Running   0          30s

NAME                                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/openshift-adp-controller-manager-metrics-service   ClusterIP   172.30.34.236    &lt;none&gt;        8443/TCP   6d5h
service/openshift-adp-velero-metrics-svc                   ClusterIP   172.30.248.193   &lt;none&gt;        8085/TCP   32s

NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/node-agent   3         3         3       3            3           &lt;none&gt;          32s

NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/openshift-adp-controller-manager   1/1     1            1           6d5h
deployment.apps/velero                             1/1     1            1           32s

NAME                                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/openshift-adp-controller-manager-f7b985677   1         1         1       6d5h
replicaset.apps/velero-7bb9f5f5bc                            1         1         1       32s</pre>
</div>
</div>
<div class="paragraph">
<p>And the <code>DataProtectionApplication</code> and <code>BackupStorageLocation</code> resources should be marked as <code>Available</code>.</p>
</div>
<div class="paragraph">
<p>Now, we have everything configured so we can start to create our backups.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html">1. Lab Setup</a></span>
  <span class="next"><a href="03-backups.html">3. Create Application Backups</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
